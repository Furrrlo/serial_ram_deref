-- TB EXAMPLE PFRL 2022-2023

-- Generated using: 
-- python3 generate_vivado_testbench.py \
--    --seed 275081253165033454762052384409687433645211693636230220518711317987964658667530915075873918884540818238445078114987637117655915643654308224093920926773573333133674128098441656696393329290138602549305636271422892295774955853005488476927676793996212995822149151566932389349817186578429946046808402940836759457820218189002038389725191251946046037968111840291253657045883253730629762598018988071062693922661774329743354196420322639547204587647445895936467552611178986298938742373249092686741496087574455026726775842059951256900916079744215307042014778151383471923428147210610020475354434931449318633177877372272693793828024506599974222787920459448529296268986319675594958207155295478154116277797441471233168661758400036886556743275262712516242703476157207491698492961077829889965252149097471051091975033628017141773428483552734496262019763514258608663297957864920444408923471939363306359512917977157599387279884034924735371438863750983297976614691068707782923240374493864828196985136331986724319011552649478585098569869708577081531112489107088877364265028107543315823156314493317429967237976213536305739523730906659257671232398320029826722842223951781311062731858889139745601654398700800800768713560823014743408142631816189474763430305663204591733383966569254682532854000065702109309896645767812444875196140229435717860006059437980801397528915835627405355863982647396784963606753798386282989647014200939670894122496392201824460987810899582596570057054770539404294853963619825291385684057220660134900534132187384002284498641328122381953268397614839898972668296915490821646250327293523118193980973390485022979552922214898150740758639323786120583375827660099042690806922459463491016231881867185010320983695720071508103509037975056283976825856965816202158431679960218335840215953954137986225249000348690045909965574226630138199428739959643595274911146101732178010504917315962576712809864615055156311956361630375993915595096320808647911783618950511138468326785005337896701138608501067810547828936035587607561379785256944583344898536347483938670057390396581910268578317604150152693649343979646272172631778931227083814480436878045967663049788335166576870673734443074077859585821353291524447437192648381991203924216879533046112561461064604727567408274065317630725603407253748264645370392476783313128898202023103010198660331580734162101909433509937776215389444267889121290356443414112020859098486406440092359478856645411796415910020110827770968214129159211339807917960028543090422449346613542755624789886289794528111738302580590226393074503278155737692899581340281662578381772695431303486263611527239162703491097701134163463073333621184464577178013366239793263157923250592929035537357632054772911353500917230192705429843012267491160721268558868422470800015239050876050563513041882507449146868624912375320783837803556857992146511380126567899298328799939936126565097424585229328973183559822636069644721451835055721845287315040452299930627045785505118130033326866230431397619686260561101793221064320281305587762403563045683173871797498417386408594997471766883417261848721395709423391678484375905921286878437684716472855512412522598645394225952637064367495912992255416696974674435650468011414831187771761578744669498280883010004929504438598948205903568816059259215286296648078620192168445947905611208472158881077394574098566888582007538085138923805870622791210768008321874030289452286276141057496742972073592993972337915072912024684502189423766968663158697307685469521800012285758047661040363238283931409384087699777736583280168348634421269999348647849486185200836074372304223040258587140587950103126154975787842640824361970756431540123437872180861663390498612438349428776625664239584837372352905742014278110655651726044872279412329386709896965914548816628490422611340338144893792363815105153412641144801686982343555617163763325466583550934141351127157272352933867711650359917403409580564049480896373339085628528045108400674293900271325520755927585707478034953282096674298855088815899406593511541781188315008153686882658819301287760738464111072711189855681506532348773464470615087441314831761794876124575488048727106983288001106564686350584264079355028898921344351272154001911118454885434963424982284751556163760945188793717961657747914515521910818088064391653119420920292447925918817461111115933675634853350066364801505592034792330744395299682778185427387843703175167559776133802137118296491774021114797751067632564341059793001662112327733640682945044045068834803491632577240196691237881750133939229188936485865323153531668448555977525480179764847391899307514322873559895476831473136758543894543841237346844477958399047270189215580391320278195046719459285300039031121664014596267154134055792191867873721211738687186572942307008821123442832439494584246011101044165671627368377837557883207183980802649100397725091812836052846166122717683648414359181006823489248739326383746181771390446016438624403548655306412038658223793885999104133602505119270538862967627421805389114832761378908359464774889814450691404077413805008021660629312269597696407202083030883557673099309320556599307418287469251029632687469289766826465904984426137866867733951303002212549437205157925181952535540980540868393420026827066239636381873674215620579729013816044587521480136943973654407297126378638098614600241586232089769464618820300289565928212605325137600231506317981592461644326169990890735815418947843053468929340959478632150561520162093433783944603240574720554737174893127843252267465595270204367305579743793697284446055645771894799974767445683106042759370308080574668218955518740049209005924285625839933055644050382513683798722351328759319671231772183956813939437003958739822181335546401110468017127068478457271670263047261450893109425259282098758724914554382287482422956352024208107741816526080660036681089714873122165498214621834823642293216604537661979322272326046307041091806632112622206769051528970980593624984689643466842932898549397950670842018315023551412916517886569120582310176674977367382052824911998053872246855396389461856069411412926417739553622992 \
--    --iterations 1 \
--    --computation_cycles 4 \
--    --full_address \
--    --multiple_resets 0.0 \
--    tb_single_longest 

--VUNIT%% library vunit_lib; %%-- 
--VUNIT%% context vunit_lib.vunit_context; %%-- 

LIBRARY ieee;
USE ieee.std_logic_1164.ALL;
USE ieee.numeric_std.ALL;
USE ieee.std_logic_unsigned.ALL;
USE std.textio.ALL;

ENTITY tb_single_longest IS
    --VUNIT%% generic(runner_cfg: string := runner_cfg_default); %%-- 
END tb_single_longest;

ARCHITECTURE projecttb OF tb_single_longest IS
    CONSTANT CLOCK_PERIOD : TIME := 100 ns;
    SIGNAL tb_done : STD_LOGIC;
    SIGNAL mem_address : STD_LOGIC_VECTOR (15 DOWNTO 0) := (OTHERS => '0');
    SIGNAL tb_rst : STD_LOGIC := '0';
    SIGNAL tb_start : STD_LOGIC := '0';
    SIGNAL tb_clk : STD_LOGIC := '0';
    SIGNAL mem_o_data, mem_i_data : STD_LOGIC_VECTOR (7 DOWNTO 0);
    SIGNAL enable_wire : STD_LOGIC;
    SIGNAL mem_we : STD_LOGIC;
    SIGNAL tb_z0, tb_z1, tb_z2, tb_z3 : STD_LOGIC_VECTOR (7 DOWNTO 0);
    SIGNAL tb_w : STD_LOGIC;

    CONSTANT SCENARIOLENGTH : INTEGER := 24;
    SIGNAL scenario_rst : unsigned(0 TO SCENARIOLENGTH - 1)     := "100000000000000000000000";
    SIGNAL scenario_start : unsigned(0 TO SCENARIOLENGTH - 1)   := "001111111111111111110000";
    SIGNAL scenario_w : unsigned(0 TO SCENARIOLENGTH - 1)       := "001011111111111111110000";
    -- Channel 2 -> MEM[1] -> 162
    -- Channel 1 -> MEM[2] -> 75

    TYPE ram_type IS ARRAY (65535 DOWNTO 0) OF STD_LOGIC_VECTOR(7 DOWNTO 0);
    SIGNAL RAM : ram_type := (  65535 => STD_LOGIC_VECTOR(to_unsigned(2289, 8)),
                                OTHERS => "00000000"-- (OTHERS => '0')
                            );

    COMPONENT project_reti_logiche IS
        PORT (
            i_clk : IN STD_LOGIC;
            i_rst : IN STD_LOGIC;
            i_start : IN STD_LOGIC;
            i_w : IN STD_LOGIC;

            o_z0 : OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
            o_z1 : OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
            o_z2 : OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
            o_z3 : OUT STD_LOGIC_VECTOR(7 DOWNTO 0);
            o_done : OUT STD_LOGIC;

            o_mem_addr : OUT STD_LOGIC_VECTOR(15 DOWNTO 0);
            i_mem_data : IN STD_LOGIC_VECTOR(7 DOWNTO 0);
            o_mem_we : OUT STD_LOGIC;
            o_mem_en : OUT STD_LOGIC
        );
    END COMPONENT project_reti_logiche;

BEGIN
    UUT : project_reti_logiche
    PORT MAP(
        i_clk => tb_clk,
        i_start => tb_start,
        i_rst => tb_rst,
        i_w => tb_w,

        o_z0 => tb_z0,
        o_z1 => tb_z1,
        o_z2 => tb_z2,
        o_z3 => tb_z3,
        o_done => tb_done,

        o_mem_addr => mem_address,
        o_mem_en => enable_wire,
        o_mem_we => mem_we,
        i_mem_data => mem_o_data
    );


    -- Process for the clock generation
    CLK_GEN : PROCESS IS
    BEGIN
        WAIT FOR CLOCK_PERIOD/2;
        tb_clk <= NOT tb_clk;
    END PROCESS CLK_GEN;


    -- Process related to the memory
    MEM : PROCESS (tb_clk)
    BEGIN
        IF tb_clk'event AND tb_clk = '1' THEN
            IF enable_wire = '1' THEN
                IF mem_we = '1' THEN
                    RAM(conv_integer(mem_address)) <= mem_i_data;
                    mem_o_data <= mem_i_data AFTER 1 ns;
                ELSE
                    mem_o_data <= RAM(conv_integer(mem_address)) AFTER 1 ns; 
                END IF;
            END IF;
        END IF;
    END PROCESS;

    -- This process provides the correct scenario on the signal controlled by the TB
    createScenario : PROCESS (tb_clk)
    BEGIN
        IF tb_clk'event AND tb_clk = '0' THEN
            tb_rst <= scenario_rst(0);
            tb_w <= scenario_w(0);
            tb_start <= scenario_start(0);
            scenario_rst <= scenario_rst(1 TO SCENARIOLENGTH - 1) & '0';
            scenario_w <= scenario_w(1 TO SCENARIOLENGTH - 1) & '0';
            scenario_start <= scenario_start(1 TO SCENARIOLENGTH - 1) & '0';
        END IF;
    END PROCESS;

    -- Process without sensitivity list designed to test the actual component.
    testRoutine : PROCESS IS
    BEGIN
        --VUNIT%% test_runner_setup(runner, runner_cfg); %%-- 

        mem_i_data <= "00000000";
        -- wait for 10000 ns;
        WAIT UNTIL tb_rst = '1';
        WAIT UNTIL tb_rst = '0';
        ASSERT tb_z0 = "00000000" REPORT "TEST FALLITO (postreset Z0 != 0 ) found " & integer'image(to_integer(unsigned(tb_z0))) severity failure; 
        ASSERT tb_z1 = "00000000" REPORT "TEST FALLITO (postreset Z1 != 0 ) found " & integer'image(to_integer(unsigned(tb_z1))) severity failure; 
        ASSERT tb_z2 = "00000000" REPORT "TEST FALLITO (postreset Z2 != 0 ) found " & integer'image(to_integer(unsigned(tb_z2))) severity failure; 
        ASSERT tb_z3 = "00000000" REPORT "TEST FALLITO (postreset Z3 != 0 ) found " & integer'image(to_integer(unsigned(tb_z3))) severity failure; 
        

        WAIT UNTIL tb_start = '1';
        ASSERT tb_z0 = "00000000" REPORT "TEST FALLITO (poststart Z0 != 0 ) found " & integer'image(to_integer(unsigned(tb_z0))) severity failure; 
        ASSERT tb_z1 = "00000000" REPORT "TEST FALLITO (poststart Z1 != 0 ) found " & integer'image(to_integer(unsigned(tb_z1))) severity failure; 
        ASSERT tb_z2 = "00000000" REPORT "TEST FALLITO (poststart Z2 != 0 ) found " & integer'image(to_integer(unsigned(tb_z2))) severity failure; 
        ASSERT tb_z3 = "00000000" REPORT "TEST FALLITO (poststart Z3 != 0 ) found " & integer'image(to_integer(unsigned(tb_z3))) severity failure;
        WAIT UNTIL tb_done = '1';
        --WAIT UNTIL rising_edge(tb_clk);
        WAIT FOR CLOCK_PERIOD/2;
        ASSERT tb_z0 = std_logic_vector(to_unsigned(0, 8))  REPORT "TEST FALLITO (Z0 ---) found " & integer'image(to_integer(unsigned(tb_z0))) & " expected " & integer'image(to_integer(to_unsigned(0, 8))) severity failure;
        ASSERT tb_z1 = std_logic_vector(to_unsigned(0, 8))  REPORT "TEST FALLITO (Z1 ---) found " & integer'image(to_integer(unsigned(tb_z1))) & " expected " & integer'image(to_integer(to_unsigned(0, 8)))  severity failure;
        ASSERT tb_z2 = std_logic_vector(to_unsigned(2289, 8))  REPORT "TEST FALLITO (Z2 ---) found " & integer'image(to_integer(unsigned(tb_z2))) & " expected " & integer'image(to_integer(to_unsigned(2289, 8)))  severity failure;
        ASSERT tb_z3 = std_logic_vector(to_unsigned(0, 8))  REPORT "TEST FALLITO (Z3 ---) found " & integer'image(to_integer(unsigned(tb_z3))) & " expected " & integer'image(to_integer(to_unsigned(0, 8)))  severity failure;
        WAIT UNTIL tb_done = '0';
        ASSERT tb_z0 = "00000000" REPORT "TEST FALLITO (postdone Z0 != 0 ) found " & integer'image(to_integer(unsigned(tb_z0))) severity failure; 
        ASSERT tb_z1 = "00000000" REPORT "TEST FALLITO (postdone Z1 != 0 ) found " & integer'image(to_integer(unsigned(tb_z1))) severity failure; 
        ASSERT tb_z2 = "00000000" REPORT "TEST FALLITO (postdone Z2 != 0 ) found " & integer'image(to_integer(unsigned(tb_z2))) severity failure; 
        ASSERT tb_z3 = "00000000" REPORT "TEST FALLITO (postdone Z3 != 0 ) found " & integer'image(to_integer(unsigned(tb_z3))) severity failure; 
        --VIVADO-START%% 
        ASSERT false REPORT "Simulation Ended! TEST PASSATO (EXAMPLE)" SEVERITY failure; 
        --VIVADO-END%% 

        --VUNIT%% test_runner_cleanup(runner); %%-- 
    END PROCESS testRoutine;

    -- One additional clock cycle for the testbench to check the last assertions 
    --VUNIT%% test_runner_watchdog(runner, CLOCK_PERIOD * (SCENARIOLENGTH + 1)); %%-- 

END projecttb;